# 第四章 网络层：数据平面

## 1、导论



### 1.1 网络层：数据平面

1. ==本章目标：==
	+ 理解网络服务的基本原理，聚焦于其==数据平面==
	  + 网络服务模型
	  + 转发和路由
	  + 路由器工作原理
	  + 通用转发
	+ 互联网中网络层协议的实例和实现
2. 网络层服务
  + 在发送主机和接收主机对之间传送段（segment）
  + 在发送端将段封装到数据报中
  + 在接收端，将段上交给传输层实体
  + 网络层协议存在于==每一个==主机 和路由器
  + 路由器检查每一个经过它的IP数据报的头部
3. 网络层的关键功能

   ==网络层功能：==

    + 转发：将分组从路由器的输入接口转发到合适的输出接口
    + 路由：使用路由算法来决定分组从发送主机到目标接收主机的路径
      + 路由选择算法
      + 路由选择协议
      ​      ==路由的类比：==

    + 转发:通过单个路口的过程
    + 路由:从源到目的的路由路径规划过程

### 1.2 网络层：数据平面、控制平面

1. ==数据平面==
   + 本地，每个路由器功能
   + 决定从路由器输入端口到达的分组如何转发到 输出端口
   + 转发功能：
     + 传统方式：基于目标地址+转发表
     + SDN方式：基于多个字段+流表
2. ==控制平面==
   + 网络范围内的逻辑
   + 决定数据报如何在路由器之间路由，决定数据报从源到目标主机之间的端到端路径
   + 2个控制平面方法:
     + 传统的路由算法: 在路由器 中被实现
     + software-defined networking  (SDN): 在远程的服务器中 实现

### 1.3 网络层：控制平面

1. 传统方式：每一路由器(per-router)控制平面

   在每一个路由器中的单独路由器算法元件，在控制平面进行交互

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/2fd3923930894d98585754159109d85eb65203fa/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.1.1.png)

2. 传统方式：路由和转发的相互作用

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/2fd3923930894d98585754159109d85eb65203fa/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.1.2.png)

3. SDN方式：逻辑集中的控制平面

   一个不同的（通常是远程的）控制器与本地控制代理（CAs)

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/2fd3923930894d98585754159109d85eb65203fa/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.1.3.png)
   
4. 网络服务模型

   Q:从发送方主机到接收方主机传输数据报的“通道” ，网络提供什么样的服务模型？
   
   ==对于单个数据报的服务:==
   
   + 可靠传送
   + 延迟保证，如：少于 40ms的延迟
   
   ==对于数据报流的服务:==
   
   + 保序数据报传送
   + 保证流的最小带宽
   + 分组之间的延迟差
   
5. 连接建立
   
   + 在某些网络架构中是第三个重要的功能
     + ATM, frame relay, X.25
   + 在分组传输之前，在两个主机之间，在通过一些 路由器所构成的路径上建立一个网络层连接
     + 涉及到路由器
   + 网络层和传输层连接服务区别:
     + ==网络层：==在2个主机之间，涉及到路径上的一些路由器
     + ==传输层：==在2个进程之间，很可能只体现在端系统上 (TCP连接)
   

## 2、路由器组成

### 2.1 路由器结构概述

高层面（非常简化的）通用路由器体系结构

1. 路由：运行==路由==选择算法/协议（RIP,OSPF,BGP)-生成路由表
2. 转发：从输入到输出链路交换数据报-根据路由表进行分组的==转发==

![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/447a91727340bcebb0c89e205ff37c3c3265785d/中科大 郑烇/resource/4.2.1.png)

### 2.2 输入端口功能

![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/447a91727340bcebb0c89e205ff37c3c3265785d/中科大 郑烇/resource/4.2.2.png)

### 2.3 最长前缀匹配

![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/447a91727340bcebb0c89e205ff37c3c3265785d/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.2.3.png)

1. 我们将会在学习IP地址时，简单讲解为什么要 采用最长前缀匹配
2. 最长前缀匹配：在路由器中经常采用TCAMs(  ternary content addressable memories)硬件来完成
   + 内容可寻址：将地址交给TCAM，它可以在一个时 钟周期内检索出地址，不管表空间有多大
   + Cisco Catalyst系列路由器: 在TCAM中可以存储多达约为1百万条路由表项

### 2.4 输入端口缓存

1. 当交换机构的速率小于输入端口的汇聚速率时， 在输入端口可能要排队

   + 排队延迟以及由于输入缓存溢出造成丢失!

2. Head-of-the-Line (HOL) blocking: 排在队头的数据报 阻止了队列中其他数据报向前移动

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/447a91727340bcebb0c89e205ff37c3c3265785d/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.2.4.png)

### 2.5 交换结构

1. 将分组从输入缓冲区传输到合适的输出端口

2. 交换速率：分组可以按照该速率从输入传输到输出

   + 运行速度经常是输入/输出链路速率的若干倍
   + N 个输入端口：交换机构的交换速度是输入线路速度的N倍比较理 想，才不会成为瓶颈

3. 3种典型的交换结构

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/447a91727340bcebb0c89e205ff37c3c3265785d/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.2.5.png)

4. 通过内存交换

   ==第一代路由器：==

   + 在CPU直接控制下的交换，采用传统的计算机
   + 分组被拷贝到系统内存，CPU从分组的头部提取出目标 地址，查找转发表，找到对应的输出端口，拷贝到输出端口
   + 转发速率被内存的带宽限制 (数据报通过BUS两遍)
   + 一次只能转发一个分组

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/447a91727340bcebb0c89e205ff37c3c3265785d/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.2.6.png)

5. 通过总线交换

   + 数据报通过共享总线，从输入端 口转发到输出端口
   + 总线竞争: 交换速度受限于总线带宽
   + 1次处理一个分组
   + 1 Gbps bus, Cisco 1900； 32  Gbps bus, Cisco 5600；对于接入或企业级路由器，速度足够（但不适合区域或骨干网络）

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/447a91727340bcebb0c89e205ff37c3c3265785d/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.2.7.png)

6. 通过互联网络（crossbar等）的交换

   + 同时并发转发多个分组，克服总线带宽限制
   + Banyan（榕树）网络，crossbar(纵横) 和其它的互联网络被开发，将多个处理器连接成多处理器
   + 当分组从端口A到达，转给端口Y；控 制器短接相应的两个总线
   + 高级设计：将数据报分片为固定长度的 信元，通过交换网络交换
   + Cisco12000：以60Gbps的交换速率通过互联网络

### 2.6 输出端口

![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/447a91727340bcebb0c89e205ff37c3c3265785d/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.2.8.png)

==数据报（分组）可能被丢弃，由于拥塞，缓冲区没有空间==

1. 当数据报从交换机构的到达速度比传输速率快 就需要输出端口==缓存==

2. 由==调度规则==选择排队的数据报进行传输

3. 输出端口排队

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/447a91727340bcebb0c89e205ff37c3c3265785d/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.2.9.png)

   + 假设交换速率Rswitch是Rline的N倍（N：输入端口的数量)
   + 当多个输入端口同时向输出端口发送时，缓冲该分组（当通 过交换网络到达的速率超过输出速率则缓存）
   + ==排队带来延迟，由于输出端口缓存溢出则丢弃数据报！==

### 2.7 调度机制

1. ==调度：==选择下一个要通过链路传输的分组

2. FIFO (first in first out)scheduling: 按照分组到来的次序发送

   + 丢弃策略:如果分组到达一个满的队列，哪个分组将会 被抛弃?
     + tail drop:丢失刚到达的分组
     + priority:根据优先权丢失/移除分组
     + random:随机的丢失/移除

3. 调度策略：优先权

   ==优先权调度：==发送最高优先权的分组

   1. 多类，不同类别有不同的 优先权
      + 类别可能依赖于标记或者其 他的头部字段, e.g. IP  source/dest, port  numbers, ds，etc.
      + 先传高优先级的队列中的分 组，除非没有
      + 高（低）优先权中的分组传 输次序：FIFO

4. 调度策略：其他的

   1. 多类
   2. 循环扫描不同类型的队列, 发送完一类的一个分组 ，再发送下一个类的一个分组，循环所有类

   

## 3、IP:Internet Protocol

### 3.1 数据报格式

1. 互联网的网络层

   主机，路由中的网络层功能

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/b37675ce80fa3c5b72b407b5c17d1dcd4e15cceb/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.3.1.png)

2. IP数据报格式

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/b37675ce80fa3c5b72b407b5c17d1dcd4e15cceb/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.3.2.png)

### 3.2 分片和重组

1. 网络链路有MTU (最大传输单元) –链路层帧所携带的最大数据长度
   + 不同的链路类型
   + 不同的MTU
2. 大的IP数据报在网络上被分片 (“fragmented”)
   + 一个数据报被分割成若干个小的数据报
     + 相同的ID
     + 不同的偏移量
     + 最后一个分片标记为0
   + “重组”只在最终的目标主机 进行
   + IP头部的信息被用于标识，排序相关分片
3. ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/b37675ce80fa3c5b72b407b5c17d1dcd4e15cceb/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.3.3.png)

### 3.3 IPV4地址

1. IP编址：引论

   + ==IP 地址:== 32位标示，对 主机或者路由器的接口编址

   + ==接口：==主机/路由器和物理链路的连接处

     + 路由器通常拥有多个接口
     + 主机也有可能有多个接口
     + IP地址和每一个接口关联

     ==一个IP地址和一个接口相关联==

2. ==子网（Subnets)==

   + IP地址：
     + 子网部分(高位bits)
     + 主机部分（低位bits)
   + 什么是子网(subnet) ?
     + 一个子网内的节点（主机或者路由器）它们的IP地址的高位部分相同 ，这些节点构成的网络的一部分叫做子网
     + ==无需路由器介入==，子网 内各主机可以在物理上 相互直接到达
   + ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/b37675ce80fa3c5b72b407b5c17d1dcd4e15cceb/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.3.4.png)
   + ==判断方法：==
     + 要判断一个子网, 将每一 个接口从主机或者路由 器上分开,构成了一个个 网络的孤岛
     + 每一个孤岛（网络）都是一个都可以被称之为 subnet.
     + 子网掩码：11111111 11111111 11111111 00000000
     + Subnet mask:/24

3. IP地址分类
   + Class A：126 networks ，16 million host
   + Class B：16382networks ，64 K hosts
   + Class C：2 million networks ，254 host
   + Class D：multicast
   +  Class E：reserved for future

​    ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/b37675ce80fa3c5b72b407b5c17d1dcd4e15cceb/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.3.5.png)

4. 特殊IP地址

   + 一些约定：
     + 子网部分：全为0--本网络
     + 主机部分：全为0--本主机
     + 主机部分：全为1--广播地址，这个网络的所有主机

5. 内网（专用)IP地址

   + 专用地址：地址空间的一部份供专用地址使用
   + 永远不会被当做公用地址来分配, 不会与公用地址重复
     + 只在局部网络中有意义，区分不同的设备
   + 路由器不对目标地址是专用地址的分组进行转发
   + 专用地址范围
     + Class A 10.0.0.0-10.255.255.255 MASK 255.0.0.0
     + Class B 172.16.0.0-172.31.255.255 MASK 255.255.0.0
     + Class C 192.168.0.0-192.168.255.255 MASK  255.255.255.0

6. IP编址：CIDR

   CIDR:Classless InterDomain Routing(无类域间路由)

   + 子网部分可以在任意的位置
   + 地址格式: a.b.c.d/x, 其中 x 是 地址中子网号的长度
   + 200.23.16.0/23
   + 子网掩码：11111111 11111111 11111110 00000000

7. 子网掩码（subnet mask）

   + 32bits , 0 or 1 in each bit
     + 1: bit位置表示子网部分
     + 0:bit位置表示主机部分
   + 原始的A、B、C类网络的子网掩码分别是
     + A：255.0.0.0 ：11111111 00000000 0000000 00000000
     + B：255.255.0.0：11111111 11111111 0000000 00000000
     + C：255.255.255.0：11111111 11111111 11111111 00000000
   + CIDR下的子网掩码例子：
     + 11111111 11111111 11111100 00000000
   + 另外的一种表示子网掩码的表达方式
     + 例：/22：表示前面22个bit为子网部分

8. 转发表和转发算法

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/b37675ce80fa3c5b72b407b5c17d1dcd4e15cceb/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.3.6.png)

   + 获得IP数据报的目标地址
   + 对于转发表中的每一个表项
     + 如 (IP Des addr) & (mask)== destination, 则按照表项 对应的接口转发该数据报
     + 如果都没有找到,则使用默认表项转发数据报

9. 如何获得一个IP地址

   Q:主机如何一个IP地址?

   + 系统管理员将地址配置在一个文件中
     + UNIX:/etc/rc.config
   + DHCP:Dynamic Host Configuration Protocol:从服务器中动态获得一个IP地址

### 3.4 DHCP:Dynamic Host Configuration Protocol

1. ==目标：==允许主机在加入网络的时候，动态地从服务器那里获得IP地址：

   + 可以更新对主机在用IP地址的租用期-租期快到了
   + 重新启动时，允许重新使用以前用过的IP地址
   + 支持移动用户加入到该网络（短期在网）

2. DHCP工作概况：

   + 主机广播“DHCP discover” 报文[可选]
   + DHCP 服务器用 “DHCP offer”提供报文响应[可选]
   + 主机请求IP地址：发送 “DHCP request” 报文
   + DHCP服务器发送地址：“DHCP ack” 报文

3. DHCP client-server scenario

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/b37675ce80fa3c5b72b407b5c17d1dcd4e15cceb/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.3.7.png)

4. DHCP:不仅仅是IP addresses

   DHCP 返回:

   + IP 地址
   + 第一跳路由器的IP地址（默认网关）
   + DNS服务器的域名和IP地址
   + 子网掩码 (指示地址部分的网络号和主机号)

5. DHCP:实例

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/b37675ce80fa3c5b72b407b5c17d1dcd4e15cceb/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.3.8.png)

   + 联网笔记本需要获取自己的IP地址，第一跳路由器地址和DNS服务器：采用 DHCP协议
   + DHCP 请求被封装在UDP段中,  封装在IP数据报中，封装在以太网的帧中
   + 以太网帧在局域网范围内广 播 (dest: FFFFFFFFFFFF) ,被运行DHCP服务的路由器收到
   + 以太网帧解封装成IP，IP 解封装成UDP，解封装成 DHCP
   + DHCP服务器生成DHCP ACK， 包含客户端的IP地址，第一 跳路由器的IP地址和DNS域 名服务器的IP地址
   + DHCP服务器封装的报文所在 的帧转发到客户端，在客户 端解封装成DHCP报文
   + 客户端知道它自己的IP地 址，DNS服务器的名字和IP 地址，第一跳路由器的IP地址

6. 如何获得一个IP地址

   Q:如何获得一个网络的子网部分?

   A：从ISP获得地址块中分配一个小地址块

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/b37675ce80fa3c5b72b407b5c17d1dcd4e15cceb/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.3.9.png)

7. 层次编址: 路由聚集（route aggregation）

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/b37675ce80fa3c5b72b407b5c17d1dcd4e15cceb/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.3.10.png)

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/b37675ce80fa3c5b72b407b5c17d1dcd4e15cceb/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/4.3.11.png)

8. IP编址：如何获得一块地址

   Q:一个ISP如何获得一个地址块?

   A：: ICANN: Internet Corporation for Assigned  Names and Numbers

   + 分配地址
   + 管理DNS
   + 分配域名，解决冲突
