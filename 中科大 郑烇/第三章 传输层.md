# 第三章 传输层

## 1、概述和传输层服务

### 1.1 第三章：传输层

**目标：**

1. 理解传输层的工作原理
   + 多路复用/解复用
   + 可靠数据传输
   + 流量控制
   + 拥塞控制
2. 学习Internet的传输层协议
   + UDP：无连接传输
   + TCP：面向连接的可靠传输
   + TCP的拥塞控制

### 1.2 第三章：提纲

1. 概述和传输层服务

2. 多路复用与解复用

3. 无连接传输：UDP

4. 可靠数据传输的原理

5. 面向连接的传输：

   TCP

   + 段结构
   + 可靠数据传输
   + 流量控制
   + 连接管理

6. 拥塞控制原理

7. TCP拥塞控制

###  1.3 传输服务和协议

1. 为运行在不同主机上的应用进程提供逻辑通信
2. 传输协议运行在端系统
   + 发送方：将应用层的报文分成==报文段==，然后传 递给网络层
   + 接收方：将报文段重组成报文，然后传递给应 用层
3. 有多个传输层协议可提供选择：
   + Internet:TCP和UDP

### 1.4 传输层 VS 网络层

1. 网络层服务：主机之间的逻辑通信

2. 传输层服务：进程间的逻辑通信

   + 依赖于网络层的服务：延时、带宽
   + 并对网络层的服务进行增强：数据丢失、顺序混乱、加密
   + 有些服务是可以加强的：不可靠 -> 可靠；安全 
   + 但有些服务是不可以被加强的：带宽，延迟

3. 类比：东西2个家庭的通信

   Ann家的12个孩子给Bill家的12个小孩发信

   + 主机 = 家
   + 进程 = 小孩
   + 应用层报文= 信封中的信件
   + 传输协议= Ann 和 Bill
     + 为家庭小孩提供复用解复用服务
   + 网络层协议 = 邮政服务
     + 家庭-家庭的邮包传输服务



### 1.5 Internet传输层协议

1. 可靠的、保序的传输：TCP
   + 多路复用、解复用
   + 拥塞控制
   + 流量控制
   + 建立连接
2. 不可靠、不保序的传输：UDP
   + 多路复用、解复用
   + 没有为尽力而为的IP服务添加更多的其它额外服务
3. 都不提供的服务：
   + 延时保证
   + 带宽保证

## 2、多路复用与解复用

### 2.1 多路复用/解复用

![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/3020409b77547334481d0056c84ac82dbd781bc9/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/3.2.1.png)

### 2.2 多路解复用工作原理

UDP和TCP不同

![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/3020409b77547334481d0056c84ac82dbd781bc9/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/3.2.1.png)

1. 解复用作用：TCP或者UDP实体采用哪些信息，将报文段的数据部分交给正确的socket，从而交给正确 的进程
2. 主机收到IP数据报
   + 每个数据报有源IP地址和目标地址
   + 每个数据报承载一个传输层报文段
   + 每个报文段有一个源端口号和目标端口号(特定应用有著名的端口号)
3. 主机联合使用IP地址和端口号将报文段发送给合适的套接字

### 2.3 无连接(UDP)多路解复用

1. 创建套接字：

   ==服务器端：==

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/3020409b77547334481d0056c84ac82dbd781bc9/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/3.2.1.png)

   serverSocket和Sad指定的端口号捆绑

   ==客户端：==

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/3020409b77547334481d0056c84ac82dbd781bc9/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/3.2.4.png)

   > 没有Bind,ClientSocket和OS为之分配的某个端口号捆绑（客户端使用什么端口号无所谓，客户端主动找服务器）

2. 在接收端，UDP套接字用二元组标示（目标IP地址、目标端口号）

3. 当主机收到UDP报文段：

   + 检查报文段的目标端口号
   + 用该端口号将报文段定位给套接字

4. 如果两个不同源IP地址/源端口号的数据报，但是有==相同的目标IP地址和端口号==，则被定位到相同的套接字

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/3020409b77547334481d0056c84ac82dbd781bc9/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/3.2.5.png)

5. 无连接多路复用：例子

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/3020409b77547334481d0056c84ac82dbd781bc9/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/3.2.6.png)

### 2.4 面向连接（TCP）的多路复用

1. TCP套接字：四元组本地标识：

   + 源IP地址
   + 源端口号
   + 目的IP地址
   + 目的端口号

2. ==解复用：==接收主机用这四个值来将数据报定位到合适的套接字

3. 服务器能够在一个TCP端口上同时支持多个TCP套接字：

   + 每个套接字由其四元组标识（有不同的源IP和源PORT）

4. Web服务器对每个连接客户端有不同的套接字

   + 非持久对每个请求有不同的套接字

5. 面向连接的解复用：例子

   ![](https://gitee.com/xatu-han-chen/computer-network-learning/raw/3020409b77547334481d0056c84ac82dbd781bc9/%E4%B8%AD%E7%A7%91%E5%A4%A7%20%E9%83%91%E7%83%87/resource/3.2.7.png)

   